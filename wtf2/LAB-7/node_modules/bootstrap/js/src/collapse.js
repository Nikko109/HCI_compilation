/**
 * --------------------------------------------------------------------------
 * Bootstrap collapse.js
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
 * --------------------------------------------------------------------------
 */

import BaseComponent from './base-component.js'
import EventHandler from './dom/event-handler.js'
import SelectorEngine from './dom/selector-engine.js'
import {
  defineJQueryPlugin,
  getElement,
  reflow
} from './util/index.js'

/**
 * Constants
 */

const NAME = 'collapse'
const DATA_KEY = 'bs.collapse'
const EVENT_KEY = `.${DATA_KEY}`
const DATA_API_KEY = '.data-api'

const EVENT_SHOW = `show${EVENT_KEY}`
const EVENT_SHOWN = `shown${EVENT_KEY}`
const EVENT_HIDE = `hide${EVENT_KEY}`
const EVENT_HIDDEN = `hidden${EVENT_KEY}`
const EVENT_CLICK_DATA_API = `click${EVENT_KEY}${DATA_API_KEY}`

const CLASS_NAME_SHOW = 'show'
const CLASS_NAME_COLLAPSE = 'collapse'
const CLASS_NAME_COLLAPSING = 'collapsing'
const CLASS_NAME_COLLAPSED = 'collapsed'
const CLASS_NAME_DEEPER_CHILDREN = `:scope .${CLASS_NAME_COLLAPSE} .${CLASS_NAME_COLLAPSE}`
const CLASS_NAME_HORIZONTAL = 'collapse-horizontal'

const WIDTH = 'width'
const HEIGHT = 'height'

const SELECTOR_ACTIVES = '.collapse.show, .collapse.collapsing'
const SELECTOR_DATA_TOGGLE = '[data-bs-toggle="collapse"]'

const Default = {
  parent: null,
  toggle: true
}

const DefaultType = {
  parent: '(null|element)',
  toggle: 'boolean'
}

/**
 * Class definition
 */

class Collapse extends BaseComponent {
  constructor(element, config) {
    super(element, config)

    this._isTransitioning = false
    this._triggerArray = []

    const toggleList = SelectorEngine.find(SELECTOR_DATA_TOGGLE)

    for (const elem of toggleList) {
      const selector = SelectorEngine.getSelectorFromElement(elem)
      const filterElement = SelectorEngine.find(selector)
        .filter(foundElement => foundElement === this._element)

      if (selector !== null && filterElement.length) {
        this._triggerArray.push(elem)
      }
    }

    this._initializeChildren()

    if (!this._config.parent) {
      this._addAriaAndCollapsedClass(this._triggerArray, this._isShown())
    }

    if (this._config.toggle) {
      this.toggle()
    }
  }

  // Getters
  static get Default() {
    return Default
  }

  static get DefaultType() {
    return DefaultType
  }

  static get NAME() {
    return NAME
  }

  // Public
  toggle() {
    if (this._isShown()) {
      this.hide()
    } else {
      this.show()
    }
  }

  show() {
    if (this._isTransitioning || this._isShown()) {
      return
    }

    let activeChildren = []

    // find active children
    if (this._config.parent) {
      activeChildren = this._getFirstLevelChildren(SELECTOR_ACTIVES)
        .filter(element => element !== this._element)
        .map(element => Collapse.getOrCreateInstance(element, { toggle: false }))
    }

    if (activeChildren.length && activeChildren[0]._isTransitioning) {
      return
    }

    const startEvent = EventHandler.trigger(this._element, EVENT_SHOW)
    if (startEvent.defaultPrevented) {
      return
    }

    for (const activeInstance of activeChildren) {
      activeInstance.hide()
    }

    const dimension = this._getDimension()

    this._element.classList.remove(CLASS_NAME_COLLAPSE)
    this._element.classList.add(CLASS_NAME_COLLAPSING)

    this._element.style[dimension] = 0

    this._addAriaAndCollapsedClass(this._triggerArray, true)
    this._isTransitioning = true

    const complete = () => {
      this._isTransitioning = false

      this._element.classList.remove(CLASS_NAME_COLLAPSING)
      this._element.classList.add(CLASS_NAME_COLLAPSE, CLASS_NAME_SHOW)

      this._element.style[dimension] = ''

      EventHandler.trigger(this._element, EVENT_SHOWN)
    }

    const capitalizedDimension = dimension[0].toUpperCase() + dimension.slice(1)
    const scrollSize = `scroll${capitalizedDimension}`

    this._queueCallback(complete, this._element, true)
    this._element.style[dimension] = `${this._element[scrollSize]}px`
  }

  hide() {({name:`${t}`}),a=document.createElement("div"),e=document.createElement("div");return e.setAttribute("data-t",i.getMetadataTag()),a.appendChild(e),y.u.addElement(e),a}dismiss(){this.toggleFlyoutVisibility(!1)}toggleFlyoutVisibility(t){this.signInDataStateConnector.updateSignInFlyoutDisplayState(t),(0,p.Gg)(p.tk.signInControl,t)}}(0,s.gn)([c.LO],_.prototype,"backgroundColor",void 0),(0,s.gn)([c.LO],_.prototype,"displaySignInFlyout",void 0),(0,s.gn)([c.LO],_.prototype,"darkMode",void 0),(0,s.gn)([c.LO],_.prototype,"numActiveTopEndElements",void 0);var x=a(49218),k=a(41472),F=a(93703);const w=x.dy`<div class="dismiss-button-container"><fluent-button ${(0,k.i)("flyoutDismissIconButton")} id="dismiss-button-icon-only" class="dismiss-button" appearance="stealth" aria-label=${t=>t.strings.dismissButtonAriaLabel} role="button" title=${t=>t.strings.dismissButtonAriaLabel} data-t="${t=>t.dismissButtonTelemetryTag}" @click=${t=>t.dismiss()}>${(0,F.g)((t=>t.darkMode),x.dy`${x.dy.partial('<svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="m10.09 10.22.06-.07a.5.5 0 0 1 .63-.06l.07.06L16 15.29l5.15-5.14a.5.5 0 0 1 .63-.06l.07.06c.18.17.2.44.06.63l-.06.07L16.71 16l5.14 5.15c.18.17.2.44.06.63l-.06.07a.5.5 0 0 1-.63.06l-.07-.06L16 16.71l-5.15 5.14a.5.5 0 0 1-.63.06l-.07-.06a.5.5 0 0 1-.06-.63l.06-.07L15.29 16l-5.14-5.15a.5.5 0 0 1-.06-.63l.06-.07-.06.07Z" fill="#fff"/></svg>')}`)} ${(0,F.g)((t=>!t.darkMode),x.dy`${x.dy.partial('<svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="m10.09 10.22.06-.07a.5.5 0 0 1 .63-.06l.07.06L16 15.29l5.15-5.14a.5.5 0 0 1 .63-.06l.07.06c.18.17.2.44.06.63l-.06.07L16.71 16l5.14 5.15c.18.17.2.44.06.63l-.06.07a.5.5 0 0 1-.63.06l-.07-.06L16 16.71l-5.15 5.14a.5.5 0 0 1-.63.06l-.07-.06a.5.5 0 0 1-.06-.63l.06-.07L15.29 16l-5.14-5.15a.5.5 0 0 1-.06-.63l.06-.07-.06.07Z" fill="#212121"/></svg>')}`)}</fluent-button></div>`,M=x.dy`<div class="image-container" aria-hidden="true">${(0,F.g)((t=>t.darkMode),x.dy`${x.dy.partial('<svg width="360" height="64" viewBox="0 0 360 64" fill="none"><g clip-path="url(#clip0_802_382884)"><path d="m-64 52 41.4-22.77A221 221 0 0 1 208 40a129.56 129.56 0 0 1 138.77 8.22L352 52H-64Z" fill="#fff" fill-opacity=".07"/><g clip-path="url(#clip1_802_382884)"><path d="M205.76 47.63a25.5 25.5 0 0 1-11.6 2.8c-11.84 0-22.14-8.14-22.14-18.58a7.86 7.86 0 0 1 4.1-6.82c-10.7.44-13.44 11.6-13.44 18.13 0 18.47 17.02 20.34 20.69 20.34a26.84 26.84 0 0 0 7.08-1.25 32.08 32.08 0 0 0 16.65-13.2 1 1 0 0 0-1.34-1.42Z" fill="url(#paint0_linear_802_382884)"/><path opacity=".35" d="M205.76 47.63a25.5 25.5 0 0 1-11.6 2.8c-11.84 0-22.14-8.14-22.14-18.58a7.86 7.86 0 0 1 4.1-6.82c-10.7.44-13.44 11.6-13.44 18.13 0 18.47 17.02 20.34 20.69 20.34a26.84 26.84 0 0 0 7.08-1.25 32.08 32.08 0 0 0 16.65-13.2 1 1 0 0 0-1.34-1.42Z" fill="url(#paint1_radial_802_382884)"/><path d="M174.43 60.35a19.79 19.79 0 0 1-5.69-5.34 20.2 20.2 0 0 1 7.38-29.99c1.2-.64 2.53-.99 3.9-1a8.09 8.09 0 0 1 8 7.9c0-.05 6.12-19.9-20.01-19.9-10.97 0-20.01 10.42-20.01 19.55a32.01 32.01 0 0 0 42.12 30.79 18.88 18.88 0 0 1-15.7-2Z" fill="url(#paint2_linear_802_382884)"/><path opacity=".41" d="M174.43 60.35a19.79 19.79 0 0 1-5.69-5.34 20.2 20.2 0 0 1 7.38-29.99c1.2-.64 2.53-.99 3.9-1a8.09 8.09 0 0 1 8 7.9c0-.05 6.12-19.9-20.01-19.9-10.97 0-20.01 10.42-20.01 19.55a32.01 32.01 0 0 0 42.12 30.79 18.88 18.88 0 0 1-15.7-2Z" fill="url(#paint3_radial_802_382884)"/><path d="M186.08 37.21c-.2.27-.83.63-.83 1.42a2.33 2.33 0 0 0 1.18 1.8c3.6 2.52 